<?phpif (!defined('BASEPATH'))    exit('No direct script access allowed');class Crop extends CI_Controller{    public function index()    {        $this->load->helper('form');        echo form_open_multipart('/crop') . form_upload('upload_photo') . form_submit() . form_close();        if (isset($_FILES['upload_photo']))        {	$dir = $crop_view['dir']=time();			mkdir("photos/" . $dir);                        move_uploaded_file($_FILES['upload_photo']['tmp_name'], "photos/" . $dir ."/". $_FILES['upload_photo']['name']);            $src = imagecreatefromjpeg("photos/". $dir. "/" . $_FILES['upload_photo']['name']);			            $maxpix = 800;            $width  = imagesx($src);            $height = imagesy($src);            $k      = 1;            if (($width <= $height) and ($height > $maxpix))            {                $k = $height / $maxpix;            }            if (($width > $height) and ($width > $maxpix))            {                $k = $width / $maxpix;            }            $crop_view["height"] = $thumb_height = $height / $k;            $crop_view["width"]  = $thumb_width = $width / $k;                                    if ($width > $maxpix or $height > $maxpix) //если какая либо сторона на загруженном изображении превышает $maxpix то уменьшаем изображение до $maxpix по неибольшей стороне            {                $thumb = imagecreatetruecolor($thumb_width, $thumb_height);                imagecopyresampled($thumb, $src, 0, 0, 0, 0, $thumb_width, $thumb_height, $width, $height);            }            else //ни чего не меняем            {                $thumb = $src;            }                        imagejpeg($thumb, "photos/".$dir."/thumb.jpg", 95);            $this->load->view("crop_view", $crop_view);                    }                if (isset($_POST['crop']))        {	$dir    = $this->input->post('dir');            $thumb  = imagecreatefromjpeg("photos/".$dir."/thumb.jpg");            $ava    = imagecreatetruecolor(100, 100);            $result = imagecopyresampled($ava, $thumb, 0, 0, $_POST['x1'], $_POST['y1'], 100, 100, $_POST['w'], $_POST['h']);            imagejpeg($ava, "photos/".$dir."/ava.jpg", 95);        }    }}?>